From 3c3db58d8846cdac8fad400a4d6b403bc884a074 Mon Sep 17 00:00:00 2001
From: crypto-das <55387659+crypto-das@users.noreply.github.com>
Date: Fri, 2 Feb 2024 13:05:29 +0000
Subject: [PATCH] Android CSP integration

---
 chrome/android/BUILD.gn                       | 12 +++++++++
 chrome/android/chrome_public_apk_tmpl.gni     |  6 +++++
 .../chrome/browser/ChromeTabbedActivity.java  | 14 ++++++++++
 3 files changed, 32 insertions(+)

diff --git a/chrome/android/BUILD.gn b/chrome/android/BUILD.gn
index 271d8ffbb5b7b..18073719f9e95 100644
--- a/chrome/android/BUILD.gn
+++ b/chrome/android/BUILD.gn
@@ -284,8 +284,20 @@ if (current_toolchain == default_toolchain) {
     srcjar_deps = [ ":chrome_android_java_google_api_keys_srcjar" ]
   }
 
+  android_aar_prebuilt("cprocsp_base_java") {
+    aar_path = "//third_party/cprocsp/libs/csp-base.aar"
+    info_path = "//third_party/cprocsp/libs/csp-base.info"
+  }
+
+  android_aar_prebuilt("cprocsp_gui_java") {
+    aar_path = "//third_party/cprocsp/libs/csp-gui.aar"
+    info_path = "//third_party/cprocsp/libs/csp-gui.info"
+  }
+
   android_library("chrome_java") {
     deps = [
+      ":cprocsp_base_java",
+      ":cprocsp_gui_java",
       ":base_module_java",
       ":chrome_app_java_resources",
       ":chrome_public_apk_template_resources",
diff --git a/chrome/android/chrome_public_apk_tmpl.gni b/chrome/android/chrome_public_apk_tmpl.gni
index 54c50b54bb7ca..2e08dd0a95453 100644
--- a/chrome/android/chrome_public_apk_tmpl.gni
+++ b/chrome/android/chrome_public_apk_tmpl.gni
@@ -729,6 +729,12 @@ template("chrome_common_apk_or_module_tmpl") {
       }
     }
 
+    deps += [ "//chrome/android:cprocsp_shared_java" ]
+    loadable_modules += [
+      "//third_party/cprocsp/jniLibs/arm64-v8a/libcspjni.so",
+      "//third_party/cprocsp/jniLibs/arm64-v8a/libsupport.so"
+    ]
+
     forward_variables_from(invoker,
                            "*",
                            TESTONLY_AND_VISIBILITY + [
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/ChromeTabbedActivity.java b/chrome/android/java/src/org/chromium/chrome/browser/ChromeTabbedActivity.java
index 74e852c79190b..2f5afed5e07f2 100644
--- a/chrome/android/java/src/org/chromium/chrome/browser/ChromeTabbedActivity.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/ChromeTabbedActivity.java
@@ -252,11 +252,22 @@ import java.util.Map;
 import java.util.Set;
 import java.util.concurrent.atomic.AtomicBoolean;
 
+import ru.CryptoPro.JCSP.NCSPConfig;
+
 /**
  * This is the main activity for ChromeMobile when not running in document mode.  All the tabs
  * are accessible via a chrome specific tab switching UI.
  */
 public class ChromeTabbedActivity extends ChromeActivity<ChromeActivityComponent> {
+    private static final String APP_LOGGER_TAG = "CSP";
+
+    private boolean initCSPProviders() {
+        int initCode   = NCSPConfig.init(this);
+        boolean initOk = initCode == NCSPConfig.CSP_INIT_OK;
+
+        return initOk;
+    }
+
     private static final String TAG = "ChromeTabbedActivity";
 
     protected static final String WINDOW_INDEX = "window_index";
@@ -525,6 +536,9 @@ public class ChromeTabbedActivity extends ChromeActivity<ChromeActivityComponent
                     }
                     minimizeAppAndCloseTabOnBackPress(getActivityTab());
                 });
+	if (!initCSPProviders()) {
+            Log.i(APP_LOGGER_TAG, "Couldn't initialize CSP.");
+        }
     }
 
     @Override
